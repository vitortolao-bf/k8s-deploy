name: Validar Kustomize e Seguran√ßa Kubernetes

on:
  pull_request:
    paths:
    - "retaguarda/qa/**"

  push:
    branches:
    - main

jobs:
  validar-kustomize:
    runs-on: ubuntu-latest

    steps:
    - name: üîÑ Checkout do reposit√≥rio
      uses: actions/checkout@v3

    - name: üß∞ Instalar Kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin

    - name: üß∞ Instalar Kubeval
      run: |
        curl -sSLo kubeval.tar.gz https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar -xzf kubeval.tar.gz
        sudo mv kubeval /usr/local/bin/
    
    - name: üß∞ Instalar kube-score
      run: |
        curl -L -o kube-score https://github.com/zegl/kube-score/releases/latest/download/kube-score-linux-amd64
        chmod +x kube-score
        sudo mv kube-score /usr/local/bin/kube-score

    - name: üîç Verificar vulnerabilidades de imagens com Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        scan-ref: .

    - name: üîç Validar Kustomize com kubeval
      run: |
        kustomize build retaguarda/qa > output.yaml
        kubeval --skip-kinds HorizontalPodAutoscaler,Ingress output.yaml

    - name: üîê Verificar falhas com kube-score
      run: |
          kube-score score retaguarda/qa/output.yaml --output-format json > result.json

          criticals=$(jq '[.[] | .grade | select(. == "critical")] | length' result.json)

          echo "Erros cr√≠ticos encontrados: $criticals"

          if [ "$criticals" -gt 0 ]; then
            echo "Falha no kube-score devido a problemas cr√≠ticos."
            exit 1
          else
            echo "Nenhum problema cr√≠tico encontrado."
          fi

    # - name: üîê Verificar falhas com kube-score
    #   run: |
    #     kube-score score retaguarda/qa/output.yaml --output-format ci
    
