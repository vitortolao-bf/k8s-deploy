name: Validar Kustomize e SeguranÃ§a Kubernetes

on:
  pull_request:
    paths:
    - "retaguarda/qa/**"

  push:
    branches:
    - main

jobs:
  validar-kustomize:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout do repositÃ³rio
      uses: actions/checkout@v3

    # - name: ğŸ§° Instalar Yamllint
    #   run: |
    #     sudo apt-get update
    #     sudo apt-get install -y yamllint

    - name: ğŸ§° Instalar Kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin

    - name: ğŸ§° Instalar Kubeval
      run: |
        curl -sSLo kubeval.tar.gz https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar -xzf kubeval.tar.gz
        sudo mv kubeval /usr/local/bin/

    - name: ğŸ§° Instalar Kube-score
      run: |
        curl -L -o kube-score https://github.com/zegl/kube-score/releases/latest/download/kube-score-linux-amd64
        chmod +x kube-score
        sudo mv kube-score /usr/local/bin/kube-score


    # - name: âœ… Validar YAML com yamllint
    #   run: |
    #     yamllint retaguarda/qa/ . -f colored

    - name: ğŸ” Verificar vulnerabilidades de imagens com Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        scan-ref: .

    - name: ğŸ” Validar Kustomize com kubeval
      run: |
        kustomize build retaguarda/qa > output.yaml
        kubeval --skip-kinds HorizontalPodAutoscaler,Ingress output.yaml


    - name: ğŸ” Verificar falhas com kube-score
      run: |
        kube-score score retaguarda/qa/output.yaml --output-format ci
